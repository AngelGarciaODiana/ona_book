<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Restructuring Data For Use in Graphs | Handbook of Graphs and Networks in People Analytics</title>
<meta name="author" content="Keith McNulty">
<meta name="description" content="So far we have learned how to define and visualize graphs to allow us to work with them. But we have made a really big assumption in doing so. We have assumed that the data we need to create our...">
<meta name="generator" content="bookdown 0.22.15 with bs4_book()">
<meta property="og:title" content="5 Restructuring Data For Use in Graphs | Handbook of Graphs and Networks in People Analytics">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ona-book.org/restructuring-data.html">
<meta property="og:image" content="https://ona-book.org/www/cover/cover-ona.png">
<meta property="og:description" content="So far we have learned how to define and visualize graphs to allow us to work with them. But we have made a really big assumption in doing so. We have assumed that the data we need to create our...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Restructuring Data For Use in Graphs | Handbook of Graphs and Networks in People Analytics">
<meta name="twitter:site" content="@dr_keithmcnulty">
<meta name="twitter:description" content="So far we have learned how to define and visualize graphs to allow us to work with them. But we have made a really big assumption in doing so. We have assumed that the data we need to create our...">
<meta name="twitter:image" content="https://ona-book.org/www/cover/cover-ona.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.9.5/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/forceNetwork-binding-0.4/forceNetwork.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="With Examples in R and Python">Handbook of Graphs and Networks in People Analytics</a>:
        <small class="text-muted">With Examples in R and Python</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="everywhere.html"><span class="header-section-number">1</span> Graphs everywhere!</a></li>
<li><a class="" href="r-intro.html"><span class="header-section-number">2</span> The Basics of the R Programming Language</a></li>
<li><a class="" href="working.html"><span class="header-section-number">3</span> Working With Graphs</a></li>
<li><a class="" href="viz-graphs.html"><span class="header-section-number">4</span> Visualizing Graphs</a></li>
<li><a class="active" href="restructuring-data.html"><span class="header-section-number">5</span> Restructuring Data For Use in Graphs</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/keithmcnulty/ona_book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="restructuring-data" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Restructuring Data For Use in Graphs<a class="anchor" aria-label="anchor" href="#restructuring-data"><i class="fas fa-link"></i></a>
</h1>
<p>So far we have learned how to define and visualize graphs to allow us to work with them. But we have made a really big assumption in doing so. We have assumed that the data we need to create our graph is always available in exactly the form in which we will need it. Usually this is an edgelist or a set of dataframes of edges and vertices. In reality, only certain types of data exist in this form by default. Typically, electronic communication data will often — though not always — have a ‘from’ and ‘to’ structure because that is how communication works and because many of the underlying systems like email, calendar or other communication networks are already built on databases that have a graph-like structure.</p>
<p>In reality, there are a lot of problems we may want to apply graph theory to problems where the data does not exist in an way that makes it easy to create a graph from it. In these cases we will need to transform the data from its existing shape to graph-friendly shape — a set of vertices and edges.</p>
<p>There are two important considerations in transforming data into a graph-friendly structure. Both of these considerations depend on the problem you are trying to solve with the graph, as follows:</p>
<ol style="list-style-type: decimal">
<li><p>What entities am I interested in connecting? These will be the vertices of your graph. This could be a single entitiy type like a set of people, or it could be multiple entity types, such as connecting people to organizational units. Complex graphs such as those in graph databases will have multiple entity types but in this chapter we will stick to one entity type in order to keep things simple.</p></li>
<li><p>How do I define the relationship between the vertices. These will be the edges of your graph. Again, there can be multiple relationship types, such as ‘reports to’ or ‘works with,’ depending on how complex your graph needs to be.</p></li>
</ol>
<p>In addition to these considerations, there are also questions of design in how you construct your graph. This is because there is often more than one option for how you can model the entities and relationships you are interested in. For example, imagine that you have two types of relationships where ‘works with’ means that two people have worked together on the same project and ‘located with’ means that two people are based in the same location. One option for modeling these in a single graph is to have a single entity type (people) connected with edges that have a ‘relationship type’ property. Another option is to have several entity types — individuals, projects and locations — as vertices, and to connect individuals to projects and locations using a single edge type that means ‘is a member of.’ In the first option the relatonships are modeled directly, but in the second they are modeled indirectly. Both may work equally well for the problem that is being solved by the graph, but one choice may be more useful or efficient than another.</p>
<p>To be able to go about these sorts of transformations requires technical and data design skills and judgment. There is no ‘one size fits all’ solution. The transformations required and how you go about them depends a great deal on the context and the purpose of the work. Nevertheless, in this chapter we will demonstrate two examples which reflect common situations where data needs to be transformed from a graph-unfriendly to a graph-friendly structure. Working through these examples should illustrate a simple design process to follow and help demonstrate typical data transformation methods that could be applied in other common situations.</p>
<p>In the first example, we will study a situation where data exists in traditional rectangular tables, but where we need to transform it in order to understand connections that we cannot understand directly from the tables themselves. This is extremely common in practice and many organizations perform these sorts of transformations in order to populate graph databases from more traditional data sources. In the second example, we will study how to extract information from documents in a way that helps us understand connections between entities in those documents. This is another common situation that has strong applications in general, but has particular potential in the fields of law and crime investigation. Both these examples will be demonstrated in detail using R, and the last section of the chapter will provide guidance for performing similar transformations using Python.</p>
<div id="transforming-data-in-rectangular-tables-for-use-in-graphs" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Transforming data in rectangular tables for use in graphs<a class="anchor" aria-label="anchor" href="#transforming-data-in-rectangular-tables-for-use-in-graphs"><i class="fas fa-link"></i></a>
</h2>
<p>In this example we are going to use some simplified tables from the <em>Chinook</em> database - an open source database which contains records of the customers, employees and transactions of a music sales company. We will be working with four simplified tables from this database which you can load from the <code>onadata</code> package now or download from the internet as follows:</p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># download chinook database tables</span>
<span class="va">chinook_employees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://ona-book.org/data/chinook_employees.csv"</span><span class="op">)</span>
<span class="va">chinook_customers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://ona-book.org/data/chinook_customers.csv"</span><span class="op">)</span>
<span class="va">chinook_invoices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://ona-book.org/data/chinook_invoices.csv"</span><span class="op">)</span>
<span class="va">chinook_items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://ona-book.org/data/chinook_items.csv"</span><span class="op">)</span>

<span class="co"># set a seed for later visualizations</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></code></pre></div>
<div id="creating-a-simple-graph-of-the-chinook-management-hierarchy" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> Creating a simple graph of the Chinook management hierarchy<a class="anchor" aria-label="anchor" href="#creating-a-simple-graph-of-the-chinook-management-hierarchy"><i class="fas fa-link"></i></a>
</h3>
<p>First, let’s take a look at a simple example of a graph that already exists in this data. Let’s take a look at a few rows of the <code>chinook_employees</code> data set.</p>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">chinook_employees</span><span class="op">)</span></code></pre></div>
<pre><code>##   EmployeeId FirstName LastName ReportsTo
## 1          1    Andrew    Adams        NA
## 2          2     Nancy  Edwards         1
## 3          3      Jane  Peacock         2
## 4          4  Margaret     Park         2
## 5          5     Steve  Johnson         2
## 6          6   Michael Mitchell         1</code></pre>
<p>We can see straight away that we can easily create a graph of the management relationships using this table. In such a graph, we would have a single entity type (the employee) as the vertices and the management relationship (‘is a manager of’) as the edges. For simplicity. let’s use first names as vertex names. By joining our data on itself, using <code>EmployeeId = ReportsTo</code>, we can create two columns with the first names of those in each management relationship.</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load dplyr for tidy manipulation in this chapter</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="co"># create edgelist</span>
<span class="op">(</span><span class="va">orgchart_edgelist</span> <span class="op">&lt;-</span> <span class="va">chinook_employees</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">chinook_employees</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"EmployeeId"</span> <span class="op">=</span> <span class="st">"ReportsTo"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   EmployeeId FirstName.x LastName.x ReportsTo EmployeeId.y FirstName.y LastName.y
## 1          1      Andrew      Adams        NA            2       Nancy    Edwards
## 2          1      Andrew      Adams        NA            6     Michael   Mitchell
## 3          2       Nancy    Edwards         1            3        Jane    Peacock
## 4          2       Nancy    Edwards         1            4    Margaret       Park
## 5          2       Nancy    Edwards         1            5       Steve    Johnson
## 6          6     Michael   Mitchell         1            7      Robert       King
## 7          6     Michael   Mitchell         1            8       Laura   Callahan</code></pre>
<p>We can see that the <code>FirstName.x</code> is the manager and so should be the <code>from</code> column and the <code>Firstname.y</code> column should be the <code>to</code> column in our edgelist. We should also remove rows were there is no edge.</p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">orgchart_edgelist</span> <span class="op">&lt;-</span> <span class="va">orgchart_edgelist</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">FirstName.x</span>, to <span class="op">=</span> <span class="va">FirstName.y</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">from</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##      from       to
## 1  Andrew    Nancy
## 2  Andrew  Michael
## 3   Nancy     Jane
## 4   Nancy Margaret
## 5   Nancy    Steve
## 6 Michael   Robert
## 7 Michael    Laura</code></pre>
<p>Now we can create a directed <code>igraph</code> object using the ‘is a manager of’ relationship.</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://igraph.org">igraph</a></span><span class="op">)</span>

<span class="co"># create orgchart graph</span>
<span class="op">(</span><span class="va">orgchart</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_data_frame.html">graph_from_data_frame</a></span><span class="op">(</span>
  d <span class="op">=</span> <span class="va">orgchart_edgelist</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## IGRAPH c0e7d0a DN-- 8 7 -- 
## + attr: name (v/c)
## + edges from c0e7d0a (vertex names):
## [1] Andrew -&gt;Nancy    Andrew -&gt;Michael  Nancy  -&gt;Jane     Nancy  -&gt;Margaret Nancy  -&gt;Steve    Michael-&gt;Robert  
## [7] Michael-&gt;Laura</code></pre>
<p>We now have a directed graph with named vertices, so this should be easy to plot. Let’s use <code>ggplot</code> with a dendrogram (tree) layout, as in Figure <a href="restructuring-data.html#fig:chinook-pretty">5.1</a>.</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggraph.data-imaginist.com">ggraph</a></span><span class="op">)</span>

<span class="co"># create management structure as dendrogram (tree)</span>
<span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html">ggraph</a></span><span class="op">(</span><span class="va">orgchart</span>, layout <span class="op">=</span> <span class="st">'dendrogram'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_elbow.html">geom_edge_elbow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_text.html">geom_node_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">name</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chinook-pretty"></span>
<img src="_main_files/figure-html/chinook-pretty-1.png" alt="Management hierarchy of Chinook as a tree" width="672"><p class="caption">
Figure 5.1: Management hierarchy of Chinook as a tree
</p>
</div>
</div>
<div id="connecting-customers-through-sales-reps" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> Connecting customers through sales reps<a class="anchor" aria-label="anchor" href="#connecting-customers-through-sales-reps"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s now try to build a graph based an a slightly more complex definition of connection. We are going to connect Chinook’s customers based on whether or not they share the same support rep. First, let’s take a look at the <code>customers</code> table.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">chinook_customers</span><span class="op">)</span></code></pre></div>
<pre><code>##   CustomerId FirstName    LastName SupportRepId
## 1          1      Luís   Gonçalves            3
## 2          2    Leonie      Köhler            5
## 3          3  François    Tremblay            3
## 4          4     Bjørn      Hansen            4
## 5          5 František Wichterlová            4
## 6          6    Helena        Holý            5</code></pre>
<p>We see a <code>SupportRepId</code> field which corresponds to the <code>EmployeeId</code> field in the <code>chinook_employees</code> table. We can join these tables to get an edgelist of customers to support rep. Let’s also create full names for better reference.</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create customer to support rep edgelist</span>
<span class="va">cust_reps</span> <span class="op">&lt;-</span> <span class="va">chinook_customers</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">chinook_employees</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SupportRepId"</span> <span class="op">=</span> <span class="st">"EmployeeId"</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    CustomerName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">FirstName.x</span>, <span class="va">LastName.x</span><span class="op">)</span>,
    RepName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">FirstName.y</span>, <span class="va">LastName.y</span><span class="op">)</span>
  <span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RepName</span>, <span class="va">CustomerName</span>, <span class="va">SupportRepId</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cust_reps</span><span class="op">)</span></code></pre></div>
<pre><code>##         RepName          CustomerName SupportRepId
## 1  Jane Peacock        Luís Gonçalves            3
## 2 Steve Johnson         Leonie Köhler            5
## 3  Jane Peacock     François Tremblay            3
## 4 Margaret Park          Bjørn Hansen            4
## 5 Margaret Park František Wichterlová            4
## 6 Steve Johnson           Helena Holý            5</code></pre>
<p>Now we have an option of creating two types of graphs. First we could create a graph from the data as is, using the <code>CustomerName</code> and <code>RepName</code> as the edgelist, and where the relationship is ‘is a customer of.’ Let’s create that graph, and view it in Figure <a href="restructuring-data.html#fig:cust-rep">5.2</a>. We see a tripartite graph with a hub-and-spoke shape.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create igraph</span>
<span class="va">cust_rep_graph</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_data_frame.html">graph_from_data_frame</a></span><span class="op">(</span>
  d <span class="op">=</span> <span class="va">cust_reps</span>
<span class="op">)</span>

<span class="co"># create customer and rep property for vertices</span>
<span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html">V</a></span><span class="op">(</span><span class="va">cust_rep_graph</span><span class="op">)</span><span class="op">$</span><span class="va">Type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html">V</a></span><span class="op">(</span><span class="va">cust_rep_graph</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="op">%in%</span> <span class="va">cust_reps</span><span class="op">$</span><span class="va">RepName</span>,
  <span class="st">"Rep"</span>,
  <span class="st">"Customer"</span>
<span class="op">)</span>

<span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html">ggraph</a></span><span class="op">(</span><span class="va">cust_rep_graph</span>, layout <span class="op">=</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_link.html">geom_edge_link</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_text.html">geom_node_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Type</span>, label <span class="op">=</span> <span class="va">name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:cust-rep"></span>
<img src="_main_files/figure-html/cust-rep-1.png" alt="Graph of Chinook customers connected to their sales reps" width="672"><p class="caption">
Figure 5.2: Graph of Chinook customers connected to their sales reps
</p>
</div>
<p>Recall our original objective is to connect customers if they have the same support rep. It is possible to use this graph to do this indirectly, applying the logic that customers are connected if there is a path between them in this graph. However we may wish to ignore the support reps completely in our graph and make directed connections between customers if they share the same support rep. To do this we need to do some further joining to our previous <code>cust_reps</code> data frame.</p>
<p>If we join this dataframe back to our <code>chinook_customers</code> dataframe, we can get customer to customer connections via a common support rep as follows:</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cust_cust</span> <span class="op">&lt;-</span> <span class="va">cust_reps</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">chinook_customers</span>, by <span class="op">=</span> <span class="st">"SupportRepId"</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Customer1 <span class="op">=</span> <span class="va">CustomerName</span>,
                Customer2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">FirstName</span>, <span class="va">LastName</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Customer1</span>, <span class="va">Customer2</span>, <span class="va">RepName</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cust_cust</span><span class="op">)</span></code></pre></div>
<pre><code>##        Customer1         Customer2      RepName
## 1 Luís Gonçalves    Luís Gonçalves Jane Peacock
## 2 Luís Gonçalves François Tremblay Jane Peacock
## 3 Luís Gonçalves   Roberto Almeida Jane Peacock
## 4 Luís Gonçalves Jennifer Peterson Jane Peacock
## 5 Luís Gonçalves   Michelle Brooks Jane Peacock
## 6 Luís Gonçalves         Tim Goyer Jane Peacock</code></pre>
<p>Now we are not interested in creating a pseudograph where customers are connected to themselves, we regard edges with reverse order as the same.</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">customer_network_edgelist</span> <span class="op">&lt;-</span> <span class="va">cust_cust</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">Customer1</span> <span class="op">!=</span> <span class="va">Customer2</span>
  <span class="op">)</span> 

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">customer_network_edgelist</span><span class="op">)</span></code></pre></div>
<pre><code>##        Customer1         Customer2      RepName
## 1 Luís Gonçalves François Tremblay Jane Peacock
## 2 Luís Gonçalves   Roberto Almeida Jane Peacock
## 3 Luís Gonçalves Jennifer Peterson Jane Peacock
## 4 Luís Gonçalves   Michelle Brooks Jane Peacock
## 5 Luís Gonçalves         Tim Goyer Jane Peacock
## 6 Luís Gonçalves     Frank Ralston Jane Peacock</code></pre>
<p>Now we have a network edgelist we can work with, with a <code>RepName</code> edge property to indicate which support rep connects the customers. Note that relationships will appear in both directions in this dataset, but we can take care of that by choosing to represent them in an undirected graph. Let’s build and visualize the graph, as in <a href="restructuring-data.html#fig:cust-cust">5.3</a>. We see a tripartite graph consisting of three complete subgraphs with the edges color coded by the Support Rep.</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create igraph object</span>
<span class="va">customer_network</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_data_frame.html">graph_from_data_frame</a></span><span class="op">(</span>
  d <span class="op">=</span> <span class="va">customer_network_edgelist</span>,
  directed <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># visualize</span>
<span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html">ggraph</a></span><span class="op">(</span><span class="va">customer_network</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_link.html">geom_edge_link</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">RepName</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html">geom_node_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightblue"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:cust-cust"></span>
<img src="_main_files/figure-html/cust-cust-1.png" alt="Customer to customer network for Chinook based on customers sharing the same sales rep" width="672"><p class="caption">
Figure 5.3: Customer to customer network for Chinook based on customers sharing the same sales rep
</p>
</div>
<div class="thinkahead">
<p><strong>Thinking ahead:</strong> Recall from Section <a href="working.html#graph-types">3.1.2</a> that a complete graph is a graph where every pair of vertices are connected by an edge. Can you see how it follows from the shape of the graph in Figure <a href="restructuring-data.html#fig:cust-rep">5.2</a> that when we transform the data to produce Figure <a href="restructuring-data.html#fig:cust-cust">5.3</a>, we expect to produce complete subgraphs? Can you also see how visually dense those complete subgraphs are? We will look at the measurement of density in graphs later, but a complete graph will alwqys have a density of 1.</p>
</div>
<!--
```{=latex}
\colorbox{babyblueeyes}{
\begin{minipage}{\textwidth}
\textbf{Playing around:} Recall from Section \ref{graph-types} that a complete graph is a graph where every pair of vertices are connected by an edge.  Can you see how it follows from the shape of the graph in Figure \ref{fig:cust-rep} that when we transform the data to produce Figure \ref{fig:cust-cust}, we expect to produce complete subgraphs?  Can you also see how visually dense those complete subgraphs are?  We will look at the measurement of density in graphs later, but a complete graph will alwqys have a density of 1.
\end{minipage}
}
```
-->
</div>
<div id="connecting-customers-through-common-purchases" class="section level3" number="5.1.3">
<h3>
<span class="header-section-number">5.1.3</span> Connecting customers through common purchases<a class="anchor" aria-label="anchor" href="#connecting-customers-through-common-purchases"><i class="fas fa-link"></i></a>
</h3>
<p>To illustrate a further layer of complexity in reshaping data for use in graphs, let’s imagine that we want to connect customers on the basis of them purchasing common products. We may wish to set some parameters to this relationship - for example a connection might be based on a minimum number of common products purchased, to give us flexibility around the definition of connection.</p>
<p>To do this we will need to use three tables - <code>chinook_customers</code>, <code>chinook_invoices</code> and <code>chinook_items</code>. To associate a given customer with a purchased item, we will need to join all three of these tables together. Let’s take a quick look at the latter two.</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">chinook_invoices</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##   InvoiceId CustomerId
## 1         1          2
## 2         2          4
## 3         3          8</code></pre>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">chinook_items</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##   InvoiceId TrackId
## 1         1       2
## 2         1       4
## 3         2       6</code></pre>
<p>We can regard the <code>TrackId</code> as an item, and using a couple of joins we can quickly match customers with items. It is possible that customers may have purchased the same item numerous times, but we are not interested in that for this work and so we just need the distinct customer and track pairings.</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cust_item</span> <span class="op">&lt;-</span> <span class="va">chinook_customers</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">chinook_invoices</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">chinook_items</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>CustName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">FirstName</span>, <span class="va">LastName</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">CustName</span>, <span class="va">TrackId</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cust_item</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##         CustName TrackId
## 1 Luís Gonçalves    3247
## 2 Luís Gonçalves    3248
## 3 Luís Gonçalves     447</code></pre>
<p>Similar to our previous example, we can now use this to create an undirected network with two vertex entities: customer and item.</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initiate graph object</span>
<span class="va">customer_item_network</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_data_frame.html">graph_from_data_frame</a></span><span class="op">(</span>
  d <span class="op">=</span> <span class="va">cust_item</span>,
  directed <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># create vertex type</span>
<span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html">V</a></span><span class="op">(</span><span class="va">customer_item_network</span><span class="op">)</span><span class="op">$</span><span class="va">Type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html">V</a></span><span class="op">(</span><span class="va">customer_item_network</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="op">%in%</span> <span class="va">cust_item</span><span class="op">$</span><span class="va">TrackId</span>,
  <span class="st">"Item"</span>,
  <span class="st">"Customer"</span>
<span class="op">)</span></code></pre></div>
<p>This is a big network, let’s visualize it simply, as in Figure <a href="restructuring-data.html#fig:cust-item-viz">5.4</a>.</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html">ggraph</a></span><span class="op">(</span><span class="va">customer_item_network</span>, layout <span class="op">=</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_link.html">geom_edge_link</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html">geom_node_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Type</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:cust-item-viz"></span>
<img src="_main_files/figure-html/cust-item-viz-1.png" alt="Network connecting customers via items purchased" width="672"><p class="caption">
Figure 5.4: Network connecting customers via items purchased
</p>
</div>
<p>We can see from looking at this graph that there are a large number of items that only one customer has purchased. Therefore the items themselves seem to be extraneous information for this particular use case. If we are not interested in the items themselves, we can instead creating the connections between customer directly. In a similar way to the previous problem, we can join the <code>cust_item</code> table on itself to connect customers based on common item purchases, and we should remove links between the same customer.</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cust_cust_itemjoin</span> <span class="op">&lt;-</span> <span class="va">cust_item</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">cust_item</span>, by <span class="op">=</span> <span class="st">"TrackId"</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>CustName1 <span class="op">=</span> <span class="va">CustName.x</span>, CustName2 <span class="op">=</span> <span class="va">CustName.y</span>, <span class="va">TrackId</span><span class="op">)</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">CustName1</span> <span class="op">!=</span> <span class="va">CustName2</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cust_cust_itemjoin</span><span class="op">)</span></code></pre></div>
<pre><code>##        CustName1          CustName2 TrackId
## 1 Luís Gonçalves     Edward Francis     449
## 2 Luís Gonçalves Richard Cunningham    1157
## 3 Luís Gonçalves Richard Cunningham    1169
## 4 Luís Gonçalves      Astrid Gruber    2991
## 5 Luís Gonçalves         Emma Jones     280
## 6 Luís Gonçalves         Emma Jones     298</code></pre>
<p>The issue with this data set is that it will count every instance of a common item purchase twicw, with the customers in opposite orders, and this is double counting. So we need to group the pairs of customers irrelevant of their order and ensure we don’t double up on items.</p>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cust_item_network</span> <span class="op">&lt;-</span> <span class="va">cust_cust_itemjoin</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>Cust1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="va">CustName1</span>, <span class="va">CustName2</span><span class="op">)</span>, Cust2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">CustName1</span>, <span class="va">CustName2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>TrackId <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">TrackId</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cust_item_network</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   Cust1          Cust2           TrackId
##   &lt;chr&gt;          &lt;chr&gt;             &lt;int&gt;
## 1 Aaron Mitchell Alexandre Rocha    2054
## 2 Aaron Mitchell Bjørn Hansen       1626
## 3 Aaron Mitchell Enrique Muñoz      2027
## 4 Aaron Mitchell Hugh O'Reilly      2018
## 5 Aaron Mitchell Niklas Schröder     857
## 6 Aaron Mitchell Phil Hughes        1822</code></pre>
<p>If that worked we should see that the table <code>cust_cust_itemjoin</code> has twice as many rows as <code>cust_item_network</code>.</p>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">cust_cust_itemjoin</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">cust_item_network</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>This looks good. So we now can count up how many common items each pair of customers purchased.</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cust_item_network</span> <span class="op">&lt;-</span> <span class="va">cust_item_network</span> |&gt; 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">Cust1</span>, <span class="va">Cust2</span>, name <span class="op">=</span> <span class="st">"Items"</span><span class="op">)</span> 

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cust_item_network</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   Cust1          Cust2           Items
##   &lt;chr&gt;          &lt;chr&gt;           &lt;int&gt;
## 1 Aaron Mitchell Alexandre Rocha     1
## 2 Aaron Mitchell Bjørn Hansen        1
## 3 Aaron Mitchell Enrique Muñoz       1
## 4 Aaron Mitchell Hugh O'Reilly       1
## 5 Aaron Mitchell Niklas Schröder     1
## 6 Aaron Mitchell Phil Hughes         1</code></pre>
<p>We are ready to construct our graph, with <code>Items</code> as an edge property. We can visualize it with an edge color code indicating how many common items were purchased, as in Figure <a href="restructuring-data.html#fig:cust-items-coded">5.5</a>.</p>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create undirected graph</span>
<span class="va">custtocust_network</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_data_frame.html">graph_from_data_frame</a></span><span class="op">(</span>
  d <span class="op">=</span> <span class="va">cust_item_network</span>,
  directed <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># visualize with edges color coded by no of items</span>
<span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html">ggraph</a></span><span class="op">(</span><span class="va">custtocust_network</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_link.html">geom_edge_link</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Items</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html">geom_node_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightblue"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:cust-items-coded"></span>
<img src="_main_files/figure-html/cust-items-coded-1.png" alt="Chinook customer to customer network based on common item purchases" width="672"><p class="caption">
Figure 5.5: Chinook customer to customer network based on common item purchases
</p>
</div>
<p>If we wish, we can restrict the definition of connection. For example, we may define it as ‘purchased at least two items in common,’ as in Figure <a href="restructuring-data.html#fig:cust-item-two">5.6</a>. We can use the <code><a href="https://rdrr.io/pkg/igraph/man/subgraph.html">subgraph()</a></code> function in <code>igraph</code> for this, and the result reveal a bipartite graph that looks quite symmetrical, indicating that there appear to be two independent groups of customers with who have some overlap purchasing behavior.</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># select edges that have Item value of at least 2</span>
<span class="va">edges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/igraph/man/E.html">E</a></span><span class="op">(</span><span class="va">custtocust_network</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/E.html">E</a></span><span class="op">(</span><span class="va">custtocust_network</span><span class="op">)</span><span class="op">$</span><span class="va">Items</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">]</span>

<span class="co"># create subgraph using these edges</span>
<span class="va">two_item_graph</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/subgraph.html">subgraph.edges</a></span><span class="op">(</span><span class="va">custtocust_network</span>, eids <span class="op">=</span> <span class="va">edges</span><span class="op">)</span>

<span class="co"># visualise</span>
<span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html">ggraph</a></span><span class="op">(</span><span class="va">two_item_graph</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_link.html">geom_edge_link</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html">geom_node_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightblue"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:cust-item-two"></span>
<img src="_main_files/figure-html/cust-item-two-1.png" alt="Chinook customer to customer network based at least two common items purchased" width="672"><p class="caption">
Figure 5.6: Chinook customer to customer network based at least two common items purchased
</p>
</div>
</div>
</div>
<div id="transforming-data-from-documents-for-use-in-graphs" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Transforming data from documents for use in graphs<a class="anchor" aria-label="anchor" href="#transforming-data-from-documents-for-use-in-graphs"><i class="fas fa-link"></i></a>
</h2>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="viz-graphs.html"><span class="header-section-number">4</span> Visualizing Graphs</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#restructuring-data"><span class="header-section-number">5</span> Restructuring Data For Use in Graphs</a></li>
<li>
<a class="nav-link" href="#transforming-data-in-rectangular-tables-for-use-in-graphs"><span class="header-section-number">5.1</span> Transforming data in rectangular tables for use in graphs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#creating-a-simple-graph-of-the-chinook-management-hierarchy"><span class="header-section-number">5.1.1</span> Creating a simple graph of the Chinook management hierarchy</a></li>
<li><a class="nav-link" href="#connecting-customers-through-sales-reps"><span class="header-section-number">5.1.2</span> Connecting customers through sales reps</a></li>
<li><a class="nav-link" href="#connecting-customers-through-common-purchases"><span class="header-section-number">5.1.3</span> Connecting customers through common purchases</a></li>
</ul>
</li>
<li><a class="nav-link" href="#transforming-data-from-documents-for-use-in-graphs"><span class="header-section-number">5.2</span> Transforming data from documents for use in graphs</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/keithmcnulty/ona_book/blob/master/r/05-restructuring_data.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/keithmcnulty/ona_book/edit/master/r/05-restructuring_data.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Handbook of Graphs and Networks in People Analytics</strong>: With Examples in R and Python" was written by Keith McNulty. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
